var weitherAPI="http://api.openweathermap.org/data/2.5/weather?appid=44db6a862fba0b067b1930da0d769e98&lang=zh&callback=?&q=",transitionend="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",API={get:"http://api.vgee.cn/msg",post:"http://api.vgee.cn/msg",policy:"http://api.vgee.cn/policy",mylocation:"http://api.vgee.cn/mylocation"},icons={"01":"&#xe604;","02":"&#xe603;","03":"&#xe606;","04":"&#xe601;","09":"&#xe600;",10:"&#xe607;",11:"&#xe602;",13:"&#xe608;",50:"&#xe605;"},PICS=20,userData={};$.fn.toShow=function(){return $(this).removeClass("hide").addClass("show")},$.fn.toHide=function(){return $(this).removeClass("show").addClass("hide")};var loadUserMsg=function(t){var e=new Date;userData.message=$(".edit #msg").val(),userData.time=e.getMonth()+1+"/"+e.getDate()+" "+e.getHours()+":"+e.getMinutes(),$.get(API.mylocation).success(function(e){if(1!=e.flag)return void(userData.city="未知");userData.city=e.data.location.city;var i=weitherAPI+userData.city;$.getJSON(i).success(function(t){return"404"==t.cod?(userData.temp=0,void(userData.weither="未知")):(userData.temp=(t.main.temp-273.15).toFixed(0),userData.weither=t.weather[0].description,void(userData.weither_icon=t.weather[0].icon.slice(0,2)))}).fail(function(){console.log("fail"),userData.temp="未知"}).always(function(){console.log("done"),userData.img=$(".thumb").attr("src"),"1pxgray.png"==userData.img&&(userData.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png"),t(userData)})})},postData=function(t){userData.message=userData.message.replace(/\n/g,"/_rt/"),console.log(userData),$.post(API.post,userData).success(function(e){t.waiting=!1,1==e.flag?window.location.href="list.html":(console.log(e),alert(JSON.stringify(e)))})},init=function(){$("#msg").textareaAutoSize().focus(),$(".submit").click(function(t){t.preventDefault();var e=Cookies.get("user");return e||(e=window.prompt("你叫什么呢？（小于10个字符)",""),e||(e=window.prompt("别淘气，你叫啥？","")),e.length>10&&(e=window.prompt("名字太非主流不好（小于10个字符)",e)),Cookies.set("user",e,{expires:1e3,path:"/"})),$(".edit #msg").val()?($(this).addClass("circle"),void loadUserMsg(function(t){userData.author=e,$(this).removeClass("circle"),$(".edit").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".preview").show().find("#prepre").text(userData.message).end().find("#picture").attr("src",userData.img).end().find("#i-temp").html(icons[userData.weither_icon]).end().find("#temp").text(userData.weither).end().find("#time").text(userData.time).end().find("#loc").text(userData.city).end().find(".user span").text(userData.user).end(),setTimeout(function(){$(".preview").toShow()})}),console.log(userData)}.bind(this))):void alert("总得说点什么吧")}),$(".ret").click(function(){$(".preview").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".edit").show(),setTimeout(function(){$(".edit").toShow()})})}),$(".go").click(function(){this.waiting||(this.waiting=!0,postData(this))}),$("#picture").click(function(){userData.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png",$(this).attr("src",userData.img)})},guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)})},previewImage=function(t,e){if(t&&/image\//.test(t.type))if("image/gif"==t.type){var i=new mOxie.FileReader;i.onload=function(){e(i.result),i.destroy(),i=null},i.readAsDataURL(t.getSource())}else{var a=new mOxie.Image;a.onload=function(){a.downsize(300,300);var t="image/jpeg"==a.type?a.getAsDataURL("image/jpeg",80):a.getAsDataURL();e&&e(t),a.destroy(),a=null},a.load(t.getSource())}};plupload.addFileFilter("limit_sharp",function(t,e,i){if(!t)return void i(!0);if("[object Array]"!==Object.prototype.toString.call(t))return void i(!0);var a=t[0],o=t[1],n=t[2],s=a/o,r=this,c=new mOxie.Image;c.load(e.getSource()),c.onload=function(){l(c)},c.onerror=function(){l(!1)};var l=function(t){if(!t)return void i(!1);console.log(t.width),console.log(t.height);var c=t.width/t.height,l=Math.abs(s-c);l>.01?(r.trigger("Error",{code:-888,message:"File sharp error.",file:e,img:{width:a,height:o}}),i(!1)):n&&t.width<n?(r.trigger("Error",{code:-889,message:"File size too small.",file:e,img:{width:a,height:o}}),i(!1)):i(!0)}}),initUploader=function(t,e,i,a,o){var n=e.policy,s=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:$(t).find(".mask")[0],container:t,flash_swf_url:"plupload/Moxie.swf",silverlight_xap_url:"plupload/Moxie.xap",url:n.host,multi_selection:!1,multipart_params:{policy:n.policyBase64,OSSAccessKeyId:n.accessid,success_action_status:"200",signature:n.signature,callback:n.callback},filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,gif"}],max_file_size:i,limit_sharp:a},init:{PostInit:function(){this._$ele=$(t),this._$imgCt=this._$ele.find(".img-ct"),this._$thumb=this._$ele.find(".thumb"),this._$count=this._$ele.find(".iconfont")},FilesAdded:function(t,e){this._$ele.addClass("uploading"),this._filename=guid()+".jpg",t.setOption({multipart_params:{Filename:this._filename,key:this._filename,policy:n.policyBase64,OSSAccessKeyId:n.accessid,success_action_status:"200",signature:n.signature,callback:n.callback}});var i=this;plupload.each(e,function(t){previewImage(t,function(t){i._$thumb.attr("src",t)}),s.start()})},UploadProgress:function(t,e){this._$count.text(e.percent.toFixed(0)+"%")},FileUploaded:function(t,e,i){this._$ele.removeClass("uploading"),this._$count.remove(),i.status>=200||i.status<200?(console.log("done"),this._$thumb.attr("src",n.host+"/"+this._filename),o(i)):console.log(i.response)},Error:function(t,e){this._$ele.removeClass("uploading");var i={};-888==e.code?i.text="请选择分辨率为 "+e.img.width+" * "+e.img.height+" 的图片":-889==e.code?i.text="请选择分辨率为 "+e.img.width+" * "+e.img.height+" 的图片":-600==e.code?i.text="图片大小超出限制":-601==e.code?i.text="文件格式错误":-200==e.code?i.text="上传错误，请重试":i.text=e.message,console.log(e)}}});s.init()},$(function(){init(),$.get(API.policy).success(function(t){initUploader($(".pic-ct")[0],t,"2048kb",!1,function(t){console.log("success")})})});